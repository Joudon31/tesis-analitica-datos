name: Extract and Upload to GCP

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"   # todos los días a las 03:00 UTC

jobs:
  extract:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      # Crear archivo gcp-key.json desde el secreto
      #printf "%s" NO modifica saltos de línea ni espacios → escribe el JSON EXACTO.
      - name: Create GCP credentials file from Base64
        run: |
          echo "${{ secrets.GCP_KEY }}" | base64 --decode > gcp-key.json

      #Vamos a decirle a Python que agregue la raíz del proyecto al PYTHONPATH.
      - name: Add project to PYTHONPATH
        run: |
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV
      
      # Ejecutar extractor en modo cloud
      - name: Run cloud extractor
        env:
          MODE: cloud
        run: |
          sed -i 's/mode: local/mode: cloud/' config.yaml
          python src/extract/fetch_datasets.py

      - name: Upload raw artifacts as backup
        uses: actions/upload-artifact@v4
        with:
          name: raw-data-backup
          path: data/raw/
