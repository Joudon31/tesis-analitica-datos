name: LOAD - Cargar a BigQuery

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "data/processed/**"

jobs:
  load-bigquery:
    runs-on: ubuntu-latest

    steps:

    - name: ðŸ”¹ Checkout repo
      uses: actions/checkout@v4

    - name: ðŸ”¹ Instalar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: ðŸ”¹ Instalar dependencias
      run: |
        pip install -r requirements.txt

    # ============================
    #  FIX 1: Crear archivo gcp-key.json desde Base64
    # Igual que en extract, asÃ­ evita errores de JSON corrupto
    # ============================
    - name: ðŸ”¹ Crear archivo de credenciales GCP desde Base64
      run: |
        echo "${{ secrets.GCP_KEY }}" | base64 --decode > gcp-key.json

    # ============================
    #  FIX 2: Agregar carpeta del proyecto al PYTHONPATH
    # Esto permite usar: from src.config_loader import load_config
    # ============================
    - name: ðŸ”¹ Configurar PYTHONPATH
      run: |
        echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

    # ============================
    # Ejecutar carga a BigQuery
    # ============================
    - name: ðŸ”¹ Ejecutar LOAD hacia BigQuery
      env:
        GOOGLE_APPLICATION_CREDENTIALS: gcp-key.json
      run: python src/load/load_to_bigquery.py
